<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Cam</title>
    <link rel='stylesheet' type='text/css' href='esp32setup.css'>
  </head>
  <body>
    <section class="main">
      <div id="logo">
        <label for="nav-toggle-cb" id="nav-toggle">&#9776;&nbsp;&nbsp;Toggle Camera Settings</label>
      </div>
      <div id="content">
        <div id="sidebar">
          <input type="checkbox" id="nav-toggle-cb" checked="checked">
            <nav id="menu">
              <div class="input-group" id="framesize-group">
                <label for="framesize">Resolution</label>
                <select id="framesize" class="default-action">
                  <!-- 2MP -->
                  <!-- <option value="13">UXGA(1600x1200)</option> TOO BIG -->
                  <option value="12">SXGA(1280x1024)</option>
                  <option value="11">HD(1280x720)</option>
                  <option value="10">XGA(1024x768)</option>
                  <option value="9">SVGA(800x600)</option>
                  <option value="8">VGA(640x480)</option>
                  <option value="7">HVGA(480x320)</option>
                  <option value="6">CIF(400x296)</option>
                  <option value="5">QVGA(320x240)</option>
                  <option value="4">240x240</option>
                  <option value="3">HQVGA(240x176)</option>
                  <option value="2">QCIF(176x144)</option>
                  <option value="1">QQVGA(160x120)</option>
                  <option value="0">96x96</option>
                </select>
              </div>

              <section id="buttons">
                <button id="get-still">Get Photo</button>
                <button id="toggle-stream">Start Stream</button>
              </section>

              <hr style="width:100%">
              <label for="nav-toggle-reg" class="toggle-section-label">&#9776;&nbsp;&nbsp;Advanced Settings</label>
              <input type="checkbox" id="nav-toggle-reg" class="hidden toggle-section-button" checked="checked">
              <section class="toggle-section">

                <div class="input-group" id="flashled-group">
                  <label for="flashled">Flash LED</label>
                  <div class="switch">
                      <input id="flashled" type="checkbox" class="default-action" checked="checked">
                      <label class="slider" for="flashled"></label>
                  </div>
                </div>
                <div class="input-group" id="timelapse-group">
                  <label for="timelapse">Time Lapse</label>
                  <div class="switch">
                      <input id="timelapse" type="checkbox" class="default-action" checked="checked">
                      <label class="slider" for="timelapse"></label>
                  </div>
                </div>

                <div class="input-group" id="hmirror-group">
                  <label for="hmirror">H-Mirror</label>
                  <div class="switch">
                      <input id="hmirror" type="checkbox" class="default-action" checked="checked">
                      <label class="slider" for="hmirror"></label>
                  </div>
                </div>
                <div class="input-group" id="vflip-group">
                  <label for="vflip">V-Flip</label>
                  <div class="switch">
                    <input id="vflip" type="checkbox" class="default-action" checked="checked">
                    <label class="slider" for="vflip"></label>
                  </div>
                </div>

                <div class="input-group" id="quality-group">
                  <label for="quality">Quality</label>
                  <div class="range-min">4</div>
                  <input type="range" id="quality" min="4" max="63" value="10" class="default-action">
                  <div class="range-max">63</div>
                </div>
                <div class="input-group" id="brightness-group">
                  <label for="brightness">Brightness</label>
                  <div class="range-min">-2</div>
                  <input type="range" id="brightness" min="-2" max="2" value="0" class="default-action">
                  <div class="range-max">2</div>
                </div>
                <div class="input-group" id="contrast-group">
                  <label for="contrast">Contrast</label>
                  <div class="range-min">-2</div>
                  <input type="range" id="contrast" min="-2" max="2" value="0" class="default-action">
                  <div class="range-max">2</div>
                </div>
                <div class="input-group" id="saturation-group">
                  <label for="saturation">Saturation</label>
                  <div class="range-min">-2</div>
                  <input type="range" id="saturation" min="-2" max="2" value="0" class="default-action">
                  <div class="range-max">2</div>
                </div>
  
                <div class="input-group" id="special_effect-group">
                  <label for="special_effect">Special Effect</label>
                  <select id="special_effect" class="default-action">
                      <option value="0" selected="selected">No Effect</option>
                      <option value="1">Negative</option>
                      <option value="2">Grayscale</option>
                      <option value="3">Red Tint</option>
                      <option value="4">Green Tint</option>
                      <option value="5">Blue Tint</option>
                      <option value="6">Sepia</option>
                  </select>
                </div>

                <div class="input-group" id="awb-group">
                  <label for="awb">AWB</label>
                  <div class="switch">
                      <input id="awb" type="checkbox" class="default-action" checked="checked">
                      <label class="slider" for="awb"></label>
                  </div>
                </div>
                <div class="input-group" id="awb_gain-group">
                  <label for="awb_gain">AWB Gain</label>
                  <div class="switch">
                      <input id="awb_gain" type="checkbox" class="default-action" checked="checked">
                      <label class="slider" for="awb_gain"></label>
                  </div>
                </div>
                <div class="input-group" id="wb_mode-group">
                  <label for="wb_mode">WB Mode</label>
                  <select id="wb_mode" class="default-action">
                      <option value="0" selected="selected">Auto</option>
                      <option value="1">Sunny</option>
                      <option value="2">Cloudy</option>
                      <option value="3">Office</option>
                      <option value="4">Home</option>
                  </select>
                </div>

                <div class="input-group" id="rotation-group">
                  <label for="rotation">Image Rotation</label>
                  <select id="rotation" class="default-action">
                      <option value="1" selected="selected">0°</option>
                      <option value="6">90°</option>
                      <option value="3">180°</option>
                      <option value="8">270°</option>
                  </select>
                </div>

              </section>

            </nav>
        </div>

        <figure>
          <div id="stream-container" class="image-container hidden">
            <div class="close" id="close-stream">×</div>
            <img id="stream" src="" crossorigin>
          </div>
        </figure>

      </div>
    </section>

    <script>

document.addEventListener('DOMContentLoaded', function (event) {
  var baseHost = document.location.origin

  function fetchUrl(url, cb){
    console.log('Fetch URL');
    fetch(url)
      .then(function (response) {
        if (response.status !== 200) {
          cb(response.status, response.statusText);
        } else {
          response.text().then(function(data){
            cb(200, data);
          }).catch(function(err) {
            cb(-1, err);
          });
        }
      })
      .catch(function(err) {
        cb(-1, err);
      });
  }

  function setReg(reg, offset, mask, value, cb){
    console.log('Set Reg', '0x'+reg.toString(16), offset, '0x'+mask.toString(16), '0x'+value.toString(16), '('+value+')');
    value = (value & mask) << offset;
    mask = mask << offset;
    fetchUrl(`${baseHost}/reg?reg=${reg}&mask=${mask}&val=${value}`, cb);
  }

  function getReg(reg, offset, mask, cb){
    console.log('Get Reg', '0x'+reg.toString(16));
    mask = mask << offset;
    fetchUrl(`${baseHost}/greg?reg=${reg}&mask=${mask}`, function(code, txt){
      let value = 0;
      if(code == 200){
        value = parseInt(txt);
        value = (value & mask) >> offset;
        txt = ''+value;
      }
      cb(code, txt);
    });
  }

  const setRegValue = (el) => {
    let reg = el.attributes.reg?parseInt(el.attributes.reg.nodeValue):0;
    let offset = el.attributes.offset?parseInt(el.attributes.offset.nodeValue):0;
    let mask = el.attributes.mask?parseInt(el.attributes.mask.nodeValue):255;
    let value = 0;
    switch (el.type) {
      case 'checkbox':
        value = el.checked ? mask : 0;
        break;
      case 'range':
      case 'text':
      case 'select-one':
        value = el.value;
        break
      default:
        return;
    }

    setReg(reg, offset, mask, value, function(code, txt){
      if(code != 200){
        alert('Error['+code+']: '+txt);
      }
    });
  }

  // Attach on change action for register elements
  document
    .querySelectorAll('.reg-action')
    .forEach(el => {
        if (el.type === 'text') {
            el.onkeyup = function(e){
                if(e.keyCode == 13){
                    setRegValue(el);
                }
            }
        } else {
            el.onchange = () => setRegValue(el)
        }
    })


  const updateRegValue = (el, value, updateRemote) => {
    let initialValue;
    let offset = el.attributes.offset?parseInt(el.attributes.offset.nodeValue):0;
    let mask = (el.attributes.mask?parseInt(el.attributes.mask.nodeValue):255) << offset;
    value = (value & mask) >> offset;
    if (el.type === 'checkbox') {
      initialValue = el.checked
      value = !!value
      el.checked = value
    } else {
      initialValue = el.value
      el.value = value
    }
  }

  const printReg = (el) => {
    let reg = el.attributes.reg?parseInt(el.attributes.reg.nodeValue):0;
    let offset = el.attributes.offset?parseInt(el.attributes.offset.nodeValue):0;
    let mask = el.attributes.mask?parseInt(el.attributes.mask.nodeValue):255;
    let value = 0;
    switch (el.type) {
      case 'checkbox':
        value = el.checked ? mask : 0;
        break;
      case 'range':
      case 'select-one':
        value = el.value;
        break
      default:
        return;
    }
    value = (value & mask) << offset;
    return '0x'+reg.toString(16)+', 0x'+value.toString(16);
  }

  const hide = el => {
    el.classList.add('hidden')
  }
  const show = el => {
    el.classList.remove('hidden')
  }

  const disable = el => {
    el.classList.add('disabled')
    el.disabled = true
  }

  const enable = el => {
    el.classList.remove('disabled')
    el.disabled = false
  }

  const updateValue = (el, value, updateRemote) => {
    updateRemote = updateRemote == null ? true : updateRemote
    let initialValue
    if (el.type === 'checkbox') {
      initialValue = el.checked
      value = !!value
      el.checked = value
    } else {
      initialValue = el.value
      el.value = value
    }

    if (updateRemote && initialValue !== value) {
      updateConfig(el);
    }
  }

  function updateConfig (el) {
    console.log('Update Config');
    let value
    switch (el.type) {
      case 'checkbox':
        value = el.checked ? 1 : 0
        break
      case 'range':
      case 'select-one':
        value = el.value
        break
      case 'button':
      case 'submit':
        value = '1'
        break
      default:
        return
    }

    const query = `${baseHost}/control?var=${el.id}&val=${value}`

    fetch(query)
      .then(response => {
        console.log(`request to ${query} finished, status: ${response.status}`)
      })
  }

  document
    .querySelectorAll('.close')
    .forEach(el => {
      el.onclick = () => {
        hide(el.parentNode)
      }
    })

  // read initial values
  fetch(`${baseHost}/status`)
    .then(function (response) {
      return response.json()
    })
    .then(function (state) {
      document
        .querySelectorAll('.default-action')
        .forEach(el => {
          updateValue(el, state[el.id], false)
        })
      document
        .querySelectorAll('.reg-action')
        .forEach(el => {
            let reg = el.attributes.reg?parseInt(el.attributes.reg.nodeValue):0;
            if(reg == 0){
              return;
            }
            updateRegValue(el, state['0x'+reg.toString(16)], false)
        })
    })

  const view = document.getElementById('stream')
  const viewContainer = document.getElementById('stream-container')
  const stillButton = document.getElementById('get-still')
  const streamButton = document.getElementById('toggle-stream')
  const closeButton = document.getElementById('close-stream')

  const stopStream = () => {
    window.stop();
    streamButton.innerHTML = 'Start Stream'
  }

  const startStream = () => {
    view.src = `${baseHost}/stream`
    show(viewContainer)
    streamButton.innerHTML = 'Stop Stream'
  }

  stillButton.onclick = () => {
    stopStream()
    view.src = `${baseHost}/capture?_cb=${Date.now()}`
    show(viewContainer)
  }

  closeButton.onclick = () => {
    stopStream()
    hide(viewContainer)
  }

  streamButton.onclick = () => {
    const streamEnabled = streamButton.innerHTML === 'Stop Stream'
    if (streamEnabled) {
      stopStream()
    } else {
      startStream()
    }
  }

  // Attach default on change action
  document
    .querySelectorAll('.default-action')
    .forEach(el => {
      el.onchange = () => updateConfig(el)
    })

})  // document.addEventListener('DOMContentLoaded'

    </script>
  </body>
</html>
